;;; -*- mode: emacs-lisp; -*-
;; initialization file for emacs editor

(add-to-list 'load-path "~/.emacs.d/various")

;; add nice 'undo tree feature'
(add-to-list 'load-path "~/.emacs.d/undo-tree")
(require 'undo-tree)
(global-undo-tree-mode)

;; custom settings for Org mode
;; using custom version of Org mode (default one from the Ubuntu distro is too old)
(add-to-list 'load-path (expand-file-name "~/.emacs.d/org/lisp"))
(add-to-list 'load-path (expand-file-name "~/.emacs.d/org/contrib/lisp"))
(require 'org-install)
(require 'org-latex)
(setq org-log-mode 'time)
(setq org-default-notes-file "~/Dropbox/org/notes.org")
(define-key global-map "\C-cc" 'org-capture)

;; load nXHtml
;; org-mode needs to be loaded before that
(load "~/.emacs.d/nxhtml/autostart.el")

;; turn on Interactively Do Things thingie
(require 'ido)
(ido-mode t)
(setq ido-enable-flex-matching t) ; fuzzy matching is a must have
(setq ido-enable-last-directory-history nil) ; forget latest selected directory names

;; Egg - Emacs got Git
;; Git
(progn
  (setq egg-dir "~/.emacs.d/egg")
  (load-file (format "%s/egg.el" egg-dir))
  (require 'egg)
  ;; override the VC settingmore sexy handling of buffer list
  (global-set-key (kbd "\C-x v d") 'egg-status)
  (global-set-key (kbd "\C-x v c") 'egg-commit-log-edit)
  (global-set-key (kbd "\C-x v i") 'egg-file-stage-current-file)
  (global-set-key (kbd "\C-x v l") 'egg-log)
  (global-set-key (kbd "\C-x v o") 'egg-file-checkout-other-version)
  (global-set-key (kbd "\C-x v u") 'egg-file-cancel-modifications)
  (global-set-key (kbd "\C-x v v") 'egg-next-action)
  (global-set-key (kbd "\C-x v =") 'egg-file-diff)
  (global-set-key (kbd "\C-x v ~") 'egg-file-version-other-window)
  (global-set-key (kbd "\C-x v b") 'egg-start-new-branch)
  (global-set-key (kbd "\C-x v a") 'egg-file-toggle-blame-mode)
)


;; From: Ryan McGreary
;; Scratch buffer goodness

;; If the *scratch* buffer is killed, recreate it automatically
(save-excursion
  (set-buffer (get-buffer-create "*scratch*"))
  (lisp-interaction-mode)
  (make-local-variable 'kill-buffer-query-functions)
  (add-hook 'kill-buffer-query-functions 'kill-scratch-buffer))

(defun kill-scratch-buffer ()
  ;; The next line is just in case someone calls this manually
  (set-buffer (get-buffer-create "*scratch*"))
  ;; Kill the current (*scratch*) buffer
  (remove-hook 'kill-buffer-query-functions 'kill-scratch-buffer)
  (kill-buffer (current-buffer))
  ;; Make a brand new *scratch* buffer
  (set-buffer (get-buffer-create "*scratch*"))
  (lisp-interaction-mode)
  (make-local-variable 'kill-buffer-query-functions)
  (add-hook 'kill-buffer-query-functions 'kill-scratch-buffer)
  ;; Since we killed it, don't let caller do that.
  nil)

;; yasnippet - cool gadget for quick coding
(add-to-list 'load-path "~/.emacs.d/yasnippet")
(require 'yasnippet)
(setq yas/root-directory "~/.emacs.d/yasnippet/snippets")
(yas/load-directory yas/root-directory)
(yas/global-mode 't)

;; smart-tab - lets test it

(require 'smart-tab)
;;(global-set-key [(tab)] 'smart-tab)

;; my settings & bindings
(setq compilation-window-height 15)
(global-set-key (kbd "\C-x \C-b") 'electric-buffer-list)  ;; more sexy handling of buffer list

;; turns on visible regions (if it's not done yet)
(unless (transient-mark-mode t)
  (transient-mark-mode))

;; GNU global tagging solution settings

(defun djcb-gtags-create-or-update ()
  "create or update the gnu global tag file"
  (interactive)
  (if (not (= 0 (call-process "global" nil nil nil " -p"))) ; tagfile doesn't exist?
    (let ((olddir default-directory)
          (topdir (read-directory-name
                    "gtags: top of source tree:" default-directory)))
      (cd topdir)
      (shell-command "gtags -q && echo 'created tagfile'")
      (cd olddir)) ; restore
    ;;  tagfile already exists; update it
    (shell-command "global -uq 2>&1 && echo 'updated tagfile'")))

(add-hook 'gtags-mode-hook  (lambda()
    (local-set-key (kbd "M-.") 'gtags-find-tag)   ; find a tag, also M-.
    (local-set-key (kbd "M-,") 'gtags-find-rtag)))  ; reverse tag

;; add the global tags creation for the programming mode - C

(add-hook 'c-mode-common-hook
  (lambda ()
    (require 'gtags)
    (gtags-mode t)
    (when (not (string-match "/usr/src/linux/" (expand-file-name default-directory)))
    (djcb-gtags-create-or-update))))

;; add the global tags creation for the programming mode - Java
(add-hook 'java-mode-hook
  (lambda()
    (require 'gtags)
    (gtags-mode t)
    (djcb-gtags-create-or-update)))

;; smex - more intelligent M-x
(add-to-list 'load-path (expand-file-name "~/.emacs.d/smex"))
(setq smex-save-file "~/.emacs.d/smex.save")
(require 'smex)
(smex-initialize)
(global-set-key (kbd "M-X") 'smex)

;; iedit package
;; allows 'dynamic' replace/edit operation on multiple places in buffer at the same time
;; (hard to define, you need to see for yourself! :)
(setq load-path (cons "~/.emacs.d/iedit" load-path))
(require 'iedit)
(define-key global-map (kbd "C-;") 'iedit-mode)

;; tracking changes - highlight changes mode
;; higlight changes in documents
;; TODO: does not load
;;(global-highlight-changes t)
;;(setq highlight-changes-visibility-initial-state nil); initially hide

;; map M-g to goto-line
(global-set-key (kbd "M-g") 'goto-line)

;; generic Emacs settings
;; From: Ryan McGreary

;; Don't show the startup screen
(setq inhibit-startup-message t)

;; "y or n" instead of "yes or no"
(fset 'yes-or-no-p 'y-or-n-p)

;; Prevent the annoying beep on errors
(setq visible-bell t)

;; Make sure all backup files only live in one place
(setq backup-directory-alist '(("." . "~/.emacs.d/backups")))

;; Gotta see matching parens
(show-paren-mode t)

;; Don't truncate lines
(setq truncate-lines t)
(setq truncate-partial-width-windows nil)

;; Trailing whitespace is unnecessary
(add-hook 'before-save-hook (lambda () (delete-trailing-whitespace)))

;; Trash can support
(setq delete-by-moving-to-trash t)

;; toggle visibility
(global-set-key (kbd "<f6>")      'highlight-changes-visible-mode) ;; changes
;; remove the change-highlight in region
(global-set-key (kbd "S-<f6>")    'highlight-changes-remove-highlight)

;; alt-pgup/pgdown jump to the previous/next change

;; if you're not already using it for something else...
(global-set-key (kbd "<M-prior>") 'highlight-changes-next-change)
(global-set-key (kbd "<M-next>")  'highlight-changes-previous-change)

;;(set-face-foreground 'highlight-changes nil)
;;(set-face-background 'highlight-changes "#F870068")
;;(set-face-foreground 'highlight-changes-delete nil)
;;(set-face-background 'highlight-changes-delete "#B80029")

;;; use groovy-mode when file ends in .groovy or has #!/bin/groovy at start
(autoload 'groovy-mode "groovy-mode" "Groovy editing mode." t)
(add-to-list 'auto-mode-alist '("\.groovy$" . groovy-mode))
(add-to-list 'auto-mode-alist '("\.story$" . groovy-mode)) ;;; easyb stories
(add-to-list 'interpreter-mode-alist '("groovy" . groovy-mode))

;; breadcrumb - intelligent bookmark saving
(require 'breadcrumb)

;;  Examples below assign a set of keys to the breadcrumb bookmark functions.
(global-set-key [(shift space)]         'bc-set)            ;; Shift-SPACE for set bookmark
(global-set-key [(meta j)]              'bc-previous)       ;; M-j for jump to previous
(global-set-key [(shift meta j)]        'bc-next)           ;; Shift-M-j for jump to next
(global-set-key [(meta up)]             'bc-local-previous) ;; M-up-arrow for local previous
(global-set-key [(meta down)]           'bc-local-next)     ;; M-down-arrow for local next
(global-set-key [(control c)(j)]        'bc-goto-current)   ;; C-c j for jump to current bookmark
(global-set-key [(control x)(meta j)]   'bc-list)           ;; C-x M-j for the bookmark menu list

;; using custom version of CEDET
;
;; TODO: use emacsmirror git repo?
;
(add-to-list 'load-path (expand-file-name "~/.emacs.d/cedet-1.0.1/common"))
(load-file "~/.emacs.d/cedet-1.0.1/common/cedet.el")
;; enable EDE (Project Management) features
(global-ede-mode 1)
;; * This enables the database and idle reparse engines
(semantic-load-enable-minimum-features)

;; fixing the ECB - we will use the CVS version, not packaged by Debian
(add-to-list 'load-path (expand-file-name "~/.emacs.d/ecb"))
(require 'ecb)

;; Malabar mode - better Java mode for Emacs
;; (check the source at https://github.com/espenhw/malabar-mode)
(add-to-list 'load-path (expand-file-name "~/.emacs.d/malabar-1.4.0/lisp"))
(require 'cedet)
(semantic-load-enable-minimum-features) ;; or enable more if you wish
(require 'malabar-mode)
(setq malabar-groovy-lib-dir (expand-file-name "~/.emacs.d/malabar-1.4.0/lib"))
(add-to-list 'auto-mode-alist '("\\.java\\'" . malabar-mode))

; optional: simulate constant compile-after-save (as in Eclipse)
;(add-hook 'malabar-mode-hook
;     (lambda ()
;       (add-hook 'after-save-hook 'malabar-compile-file-silently
;                  nil t)))

;; JDEE - temporarily turned off
;;(add-to-list 'load-path (expand-file-name "~/.emacs.d/jdee-2.4.0.1/lisp"))
;;(add-to-list 'load-path (expand-file-name "~/.emacs.d/elib-1.0"))
;;(require 'jde)


;; set the color scheme
(require 'color-theme)
;;(color-theme-initialize)
(color-theme-dark-laptop)


;; global keyboard mapping for Emacs' anything
(global-set-key (kbd "s-a") 'anything)

(add-hook 'c-mode-common-hook
	  (lambda ()
	    (font-lock-add-keywords nil
                 '(("\\<\\(FIXME\\|TODO\\|BUG\\):" 1 font-lock-warning-face t)))))

;; twittering mode
(add-to-list 'load-path (expand-file-name "~/.emacs.d/twittering-mode"))
(setq twittering-proxy-use t)
(setq twittering-proxy-server "yellow.nc3a.nato.int")
(setq twittering-proxy-port 8088)
(require 'twittering-mode)

;; set default web browser to Google Chrome
(setq browse-url-browser-function 'browse-url-generic
      browse-url-generic-program "google-chrome")

;; show nice window of recently killed lines in the kill ring
(global-set-key "\C-cy" '(lambda ()
   (interactive)
   (popup-menu 'yank-menu)))

;; 'djcb-org-article' for export org documents to the LaTex 'article', using
;; XeTeX and some fancy fonts; requires XeTeX (see org-latex-to-pdf-process)
;;(require 'org-latex)
;;(unless (boundp 'org-export-latex-classes)
;;  (setq org-export-latex-classes nil))
(add-to-list 'org-export-latex-classes
  '("article-djcb"
"\\documentclass[11pt,a4paper]{article}
\\usepackage[T1]{fontenc}
\\usepackage{fontspec}
\\usepackage{graphicx}
\\defaultfontfeatures{Mapping=tex-text}
\\setromanfont{Gentium}
\\setromanfont [BoldFont={Gentium Basic Bold},
                ItalicFont={Gentium Basic Italic}]{Gentium Basic}
\\setsansfont{Charis SIL}
\\setmonofont[Scale=0.8]{DejaVu Sans Mono}
\\usepackage{geometry}
\\geometry{a4paper, textwidth=6.5in, textheight=10in,
            marginparsep=7pt, marginparwidth=.6in}
\\pagestyle{empty}
\\title{}
[NO-DEFAULT-PACKAGES]
[NO-PACKAGES]"
     ("\\section{%s}" . "\\section*{%s}")
     ("\\subsection{%s}" . "\\subsection*{%s}")
     ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
     ("\\paragraph{%s}" . "\\paragraph*{%s}")
     ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))

(setq org-latex-to-pdf-process
  '("xelatex -interaction nonstopmode %f"
     "xelatex -interaction nonstopmode %f")) ;; for multiple passes

;; mode for editing BAT files (sometimes it happens)
(setq auto-mode-alist
      (append
       (list (cons "\\.[bB][aA][tT]$" 'bat-mode))
       ;; For DOS init files
       (list (cons "CONFIG\\."   'bat-mode))
       (list (cons "AUTOEXEC\\." 'bat-mode))
       auto-mode-alist))

   (autoload 'bat-mode "bat-mode"
      "DOS and WIndows BAT files" t)

;; anything.el - quick way to access 'things' in Emacs
(add-to-list 'load-path "~/.emacs.d/anything")
(require 'anything-config)
;; (require 'anything) [ not needed? ]
;; (require 'anything-gtags) [ not needed? ]


;; http://jblevins.org/projects/deft/
(add-to-list 'load-path "~/.emacs.d/deft")
(when (require 'deft nil 'noerror)
   (setq
      deft-extension "org"
      deft-directory "~/Dropbox/org/deft/"
      deft-text-mode 'org-mode
      deft-auto-save-interval 5.0)
   (global-set-key (kbd "<f9>") 'deft))

;; set up w3m rendering for newsticker
(autoload 'w3m-region "w3m"
  "Render region in current buffer and replace with result." t)

(autoload 'w3m-toggle-inline-image "w3m"
  "Toggle the visibility of an image under point." t)

(custom-set-variables
  ;; custom-set-variables was added by Custom.
  ;; If you edit it by hand, you could mess it up, so be careful.
  ;; Your init file should contain only one such instance.
  ;; If there is more than one, they won't work right.
 '(ack-executable (executable-find "ack-grep"))
 '(bsh-jar "~/work/javautil/beanshell/bsh.jar")
 '(bsh-startup-timeout 2)
 '(bsh-vm-args (quote ("-Djava.net.preferIPv4Stack=true" "-Dhttp.proxyHost=yellow.nc3a.nato.int" "-Dhttp.proxyPort=8088")))
 '(compilation-scroll-output t)
 '(compilation-skip-threshold 2)
 '(ecb-options-version "2.40")
 '(ecb-source-path (quote ("~/work/projects")))
 '(ecb-tree-indent 2)
 '(gtags-path-style (quote relative))
 '(jde-ant-home "/usr/share/ant")
 '(jde-ant-read-target t)
 '(jde-global-classpath (quote ("./lib" "./lib/jetty" "./build")))
 '(jde-jdk-registry (quote (("1.6.0_24" . "/home/luke/work/jdk/jdk1.6.0_24"))))
 '(org-agenda-files (quote ("~/Dropbox/org" "~/Dropbox/org/deft" "~/.org-mode/")))
 '(org-capture-templates (quote (("t" "Todo" entry (file+headline "~/Dropbox/org/agenda.org" "Tasks") (file "~/Dropbox/org/templates/todo.orgtmpl"))))))

(custom-set-faces
  ;; custom-set-faces was added by Custom.
  ;; If you edit it by hand, you could mess it up, so be careful.
  ;; Your init file should contain only one such instance.
  ;; If there is more than one, they won't work right.
 )

;; workgroups.el - manage window configuration in the frame the eas way
;; https://github.com/tlh/workgroups.el

(add-to-list 'load-path (expand-file-name "~/.emacs.d/workgroups.el"))
(require 'workgroups)
(setq wg-prefix-key (kbd "C-c w"))
(workgroups-mode 1)
(wg-load (expand-file-name "~/.emacs.d/workgroups-saved"))

;; full-ack.el
(add-to-list 'load-path (expand-file-name "~/.emacs.d/full-ack/"))
(autoload 'ack-same "full-ack" nil t)
(autoload 'ack "full-ack" nil t)
(autoload 'ack-find-same-file "full-ack" nil t)
(autoload 'ack-find-file "full-ack" nil t)

;; WindMove - smarter window switching
;; switch between windows with 'super'-up/down/left/right
(windmove-default-keybindings 'super)

;; quick and easy font re-size
(defun djcb-zoom (n)
  "with positive N, increase the font size, otherwise decrease it"
  (set-face-attribute 'default (selected-frame) :height
    (+ (face-attribute 'default :height) (* (if (> n 0) 1 -1) 10))))

(global-set-key (kbd "C-+")      '(lambda nil (interactive) (djcb-zoom 1)))
(global-set-key [C-kp-add]       '(lambda nil (interactive) (djcb-zoom 1)))
(global-set-key (kbd "C--")      '(lambda nil (interactive) (djcb-zoom -1)))
(global-set-key [C-kp-subtract]  '(lambda nil (interactive) (djcb-zoom -1)))

;; use EasyPG to automatically encrypt and decrypt all files that end with *.gpg
(require 'epa-file)
(epa-file-enable)

;; use js2-mode for editing JavaScript
(add-to-list 'load-path (expand-file-name "~/.emacs.d/js2-mode"))
(add-to-list 'auto-mode-alist '("[.]js$" . js2-mode))
(require 'js2-mode)
